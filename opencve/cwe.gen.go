package opencve

import (
	"context"
	"net/http"
	"net/url"
	"path"
)

const cweURL = "api/cwe"

// CWEService is an interface for interacting with the cwe endpoints
type CWEService interface {
	List(context.Context) (*CWEList, error)
	Get(context.Context, string) (*CWEDetails, error)
}

// CWE is the interface between the HTTP client and the OpenCVE cwes endpoints
func (c *Client) CWE() CWEService {
	return &CWEClient{client: c}
}

// CWEClient facilitates requests with the cwe endpoints
type CWEClient struct {
	client *Client
}

// List cwe
func (c *CWEClient) List(ctx context.Context) (*CWEList, error) {
	url := &url.URL{
		Scheme: "https",
		Host:   c.client.apiURL,
		Path:   cweURL,
	}

	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url.String(), nil)
	if err != nil {
		return nil, err
	}

	res := &CWEList{}
	_, err = c.client.makeRequest(req, res)
	if err != nil {
		return nil, err
	}

	return res, nil
}

// Get retrieves a specific cwe
func (c *CWEClient) Get(ctx context.Context, ID string) (*CWEDetails, error) {
	url := &url.URL{
		Scheme: "https",
		Host:   c.client.apiURL,
		Path:   path.Join(cweURL, ID),
	}

	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url.String(), nil)
	if err != nil {
		return nil, err
	}

	res := &CWEDetails{}
	_, err = c.client.makeRequest(req, res)
	if err != nil {
		return nil, err
	}

	return res, nil
}
